Name:		wicked
Version:	@PACKAGE_VERSION@
Release:	0
Group:		System/Management
License:	GPL-2.0
Summary:	Network configuration infrastructure
Url:            @PACKAGE_URL@
Source0:	%{name}-%{version}.tar.bz2
Source1:        wicked-rpmlintrc
Buildroot:	%{_tmppath}/%{name}%{version}-buildroot/
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}

%if 0%{?suse_version} >= 1230
%bcond_without  systemd
%bcond_with     dbusstart
%else
%bcond_with     systemd
%bcond_with     dbusstart
%endif

%if 0%{?suse_version} >= 1210
BuildRequires:  libnl-1_1-devel
%else
BuildRequires:  libnl-devel
%endif
%if 0%{?suse_version} > 1110
BuildRequires:  libiw-devel
%else
BuildRequires:  wireless-tools
%endif
BuildRequires:  dbus-1-devel
BuildRequires:  pkg-config
BuildRequires:  libgcrypt-devel

%if %{with systemd}
%{?systemd_requires}
BuildRequires:  pkgconfig(systemd)
%if 0%{?suse_version:1}
Requires(pre):  %fillup_prereq
%endif
%else
%if 0%{?suse_version:1}
PreReq:         %fillup_prereq %insserv_prereq
%endif
%endif

%description
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

%package client
License:        GPL-2.0
Group:          System/Management
Summary:        Network configuration infrastructure - Client
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}
Requires:       %name = %{version}

%description client
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked client.

%package nanny
License:        GPL-2.0
Group:          System/Management
Summary:        Network configuration infrastructure - Nanny
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}
Requires:       %name = %{version}

%description nanny
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked nanny.

%package devel
License:        GPL-2.0
Group:          Development/Libraries/C and C++
Summary:        Network configuration infrastructure - Development files
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}
Requires:       dbus-1-devel
Requires:       libnl-devel
%if 0%{?suse_version} > 1210
Requires:       libnl-1_1-devel
%else
Requires:       libnl-devel
%endif

%description devel
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked development files.

%package -n     libwicked@LIBWICKED_PACKAGE_SUFFIX@
License:        GPL-2.0
Summary:        Network configuration infrastructure - Shared library
Group:          System/Management

%description -n libwicked@LIBWICKED_PACKAGE_SUFFIX@
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked shared library.

%if %{with systemd}

%package systemd
License:        GPL-2.0
Group:          System/Management
Summary:        Network configuration infrastructure - System-D Services
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}
Requires:       %name = %{version}
Requires:       sysconfig >= 0.81.0
Obsoletes:      sysconfig < 0.81.0
Conflicts:      otherproviders(sysvinit(network))
Provides:       sysvinit(network)

%description systemd
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked systemd service files.

%else

%package sysvinit
License:        GPL-2.0
Group:          System/Management
Summary:        Network configuration infrastructure - SysV-Init Scripts
Requires:       libwicked@LIBWICKED_PACKAGE_SUFFIX@ = %{version}
Requires:       %name = %{version}
Requires:       sysconfig >= 0.81.0
Obsoletes:      sysconfig < 0.81.0
Conflicts:      otherproviders(sysvinit(network))

%description sysvinit
Wicked is a network configuration infrastructure incorporating a number
of existing frameworks into a unified architecture, providing a DBUS
interface to network configuration.

This package provides the wicked system V init scripts.

%endif

%prep
%setup

%build
export CFLAGS="$RPM_OPT_FLAGS"
%configure \
%if %{with systemd}
	--enable-systemd		\
%else
	--enable-systemv		\
%endif
%if ! %{with dbusstart}
	--without-dbus-servicedir	\
%endif
	--disable-static
make %{?_smp_mflags}

%install
make install DESTDIR=${RPM_BUILD_ROOT}
# remove libwicked.a and la
%__rm -f ${RPM_BUILD_ROOT}%_libdir/libwicked*.*a
# create ghost directory
%__mkdir_p -m 0750 ${RPM_BUILD_ROOT}%_localstatedir/run/wicked

%if %{with systemd}

%pre systemd
%{service_add_pre wicked.service}

%post systemd
%{service_add_post wicked.service}

%preun systemd
# stop the daemons on removal
%{service_del_preun wickedd.service}
%{service_del_preun wicked-dhcp4.service}
%{service_del_preun wicked-dhcp6.service}
%{service_del_preun wicked-autoip4.service}

%postun systemd
%{service_del_postun wickedd.service}

%else

%post sysvinit
%{fillup_and_insserv wickedd}

%preun sysvinit
if test -x /etc/init.d/wicked ; then
	%stop_on_removal wickedd
fi

%postun sysvinit
if test -x /etc/init.d/wicked ; then
	%restart_on_update wickedd
fi
%insserv_cleanup

%endif

%post -n libwicked@LIBWICKED_PACKAGE_SUFFIX@
/sbin/ldconfig

%postun -n libwicked@LIBWICKED_PACKAGE_SUFFIX@
/sbin/ldconfig

%post
%__mkdir_p -m 0750 %_localstatedir/run/wicked

%files
%defattr (-,root,root)
%doc ChangeLog ANNOUNCE COPYING README TODO samples
%_sbindir/wickedd
%dir %_libexecdir/%{name}
%dir %_libexecdir/%{name}/bin
%_libexecdir/%{name}/bin/wicked-dhcp4
%_libexecdir/%{name}/bin/wicked-dhcp6
%_libexecdir/%{name}/bin/wicked-autoip4
%dir %_sysconfdir/wicked
%config(noreplace) %_sysconfdir/wicked/common.xml
%config(noreplace) %_sysconfdir/wicked/server.xml
%dir %_sysconfdir/wicked/extensions
%config(noreplace) %_sysconfdir/wicked/extensions/*
%dir %_sysconfdir/dbus-1
%dir %_sysconfdir/dbus-1/system.d
%config(noreplace) %_sysconfdir/dbus-1/system.d/wicked.conf
%config(noreplace) %_sysconfdir/dbus-1/system.d/wicked-dhcp6.conf
%config(noreplace) %_sysconfdir/dbus-1/system.d/wicked-dhcp4.conf
%config(noreplace) %_sysconfdir/dbus-1/system.d/wicked-autoip4.conf
%if %{with dbusstart}
%dir %_datadir/dbus-1
%dir %_datadir/dbus-1/system-services
%_datadir/dbus-1/system-services/org.opensuse.Network.*.service
%endif
%dir %_datadir/wicked/schema
%config(noreplace) %_datadir/wicked/schema/*.xml
%_mandir/man5/wicked-config.5*
%_mandir/man8/wickedd.8*
%attr(0750,root,root) %dir %ghost %_localstatedir/run/wicked

%if %{with systemd}
%files systemd
%defattr (-,root,root)
%_unitdir/wicked-autoip4.service
%_unitdir/wicked-dhcp4.service
%_unitdir/wicked-dhcp6.service
%_unitdir/wicked.service
%_unitdir/wickedd.service

%else

%files sysvinit
%defattr (-,root,root)
%_sysconfdir/init.d/wickedd
%_sysconfdir/init.d/network
%_sbindir/rcwickedd
%_sbindir/rcnetwork

%endif

%files client
%defattr (-,root,root)
%dir %_sysconfdir/wicked
%dir %_sysconfdir/wicked/ifconfig
%config(noreplace) %_sysconfdir/wicked/client.xml
%_sbindir/wicked
%_mandir/man8/wicked.8*

%files nanny
%defattr (-,root,root)
%dir %_sysconfdir/wicked
%config(noreplace) %{_sysconfdir}/wicked/network-nanny.xml
%dir %_sysconfdir/dbus-1
%dir %_sysconfdir/dbus-1/system.d
%config(noreplace) %_sysconfdir/dbus-1/system.d/network-nanny.conf
%_sbindir/network-nanny

%files devel
%defattr (-,root,root)
%dir %_includedir/wicked
%_includedir/wicked/*
%_libdir/libwicked*.so
%_datadir/pkgconfig/wicked.pc
%_mandir/man7/wicked.7*

%files -n libwicked@LIBWICKED_PACKAGE_SUFFIX@
%defattr (-,root,root)
%_libdir/libwicked*.so.*

%changelog
